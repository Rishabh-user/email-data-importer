{% extends "admin/change_list.html" %}
{% load static %}

{% block object-tools %}
{{ block.super }}

<div id="admin-message-box" style="margin-top:10px;"></div>

<!-- âœ… PROGRESS BOX -->
<div id="progress-box"
     style="
        display:none;
        margin-top:12px;
        padding:12px;
        border:1px solid #ddd;
        border-radius:8px;
        background:#f9fafb;
        max-width:600px;
     ">

    <strong>Processing Records</strong>

    <div style="border:1px solid #ccc;height:26px;margin-top:8px;">
        <div id="progress-bar"
             style="
                width:0%;
                height:100%;
                background:#22c55e;
                color:white;
                text-align:center;
                line-height:26px;
                font-weight:600;
             ">
            0 / 0
        </div>
    </div>

    <div id="progress-text" style="margin-top:6px;font-weight:600;"></div>
</div>
{% endblock %}

{% block extrahead %}
{{ block.super }}
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie("csrftoken");

document.addEventListener("DOMContentLoaded", function () {

    const ul = document.querySelector(".object-tools");
    if (!ul) return;

    /* ---------- BUTTON ---------- */
    const li = document.createElement("li");
    const btn = document.createElement("a");
    btn.href = "#";
    btn.className = "button";
    btn.textContent = "ðŸš€ Process Records";
    btn.style.cssText = `
        background:#2563eb;
        color:white;
        padding:8px 14px;
        font-weight:600;
        border-radius:8px;
        margin-left:8px;
    `;
    li.appendChild(btn);
    ul.appendChild(li);

    /* ---------- UI ---------- */
    const box = document.getElementById("progress-box");
    const bar = document.getElementById("progress-bar");
    const text = document.getElementById("progress-text");
    const msgBox = document.getElementById("admin-message-box");

    let polling = false;

    function showMessage(type, message) {
        msgBox.innerHTML = `
            <ul class="messagelist">
                <li class="${type}">${message}</li>
            </ul>
        `;
    }

    function clearMessage() {
        msgBox.innerHTML = "";
    }

    function resetUI() {
        polling = false;
        bar.style.width = "0%";
        bar.textContent = "0 / 0";
        text.textContent = "";
        box.style.display = "none";
        btn.style.pointerEvents = "auto";
        btn.textContent = "ðŸš€ Process Records";
    }

    /* ---------- CLICK ---------- */
    btn.addEventListener("click", function (e) {
        e.preventDefault();
        if (polling) return;

        clearMessage();
        btn.style.pointerEvents = "none";
        btn.textContent = "â³ Startingâ€¦";

        fetch("process/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken
            },
        })
        .then(res => {
            if (!res.ok) throw new Error("HTTP " + res.status);
            return res.json();
        })
        .then(data => {
            if (data.status === "nothing") {
                showMessage("warning", "No unprocessed records found.");
                resetUI();
                return;
            }

            polling = true;
            box.style.display = "block";
            btn.textContent = "â³ Processingâ€¦";
            poll();
        })
        .catch(err => {
            console.error(err);
            resetUI(); // no intermediate error message
        });
    });

    /* ---------- POLLING ---------- */
    function poll() {
        if (!polling) return;

        fetch("process-status/")
            .then(res => {
                if (!res.ok) throw new Error("HTTP " + res.status);
                return res.json();
            })
            .then(data => {
                if (!data.total || data.total === 0) {
                    resetUI();
                    return;
                }

                const percent = data.percent || 0;
                bar.style.width = percent + "%";
                bar.textContent = `${data.processed} / ${data.total}`;
                text.textContent =
                    `Processed ${data.processed} of ${data.total} | Failed ${data.failed}`;

                if (data.running) {
                    setTimeout(poll, 1000);
                } else {
                    btn.textContent = "âœ… Completed";
                    polling = false;

                    setTimeout(() => {
                        fetch("process-reset/", {
                            method: "POST",
                            headers: { "X-CSRFToken": csrftoken }
                        });
                        resetUI();

                        // âœ… Show final success message only
                        showMessage("success", `Processing complete â†’ Success: ${data.processed}, Failed: ${data.failed}`);
                    }, 1500);
                }
            })
            .catch(err => {
                console.error(err);
                resetUI(); // no intermediate error message
            });
    }
});
</script>

{% endblock %}
